# 表單系統專案架構書

## 1. 專案概述

### 1.1 專案名稱
Forma - 動態表單管理系統

### 1.2 專案目標
打造一個功能完整的企業級表單系統，支援動態表單建立、資料收集、權限管理與報告生成。

### 1.3 技術棧
- **前端**: React 18+
- **後端**: .NET Core 8
- **資料庫**: PostgreSQL 15+
- **部署**: Docker + Kubernetes（可選）

---

## 2. 系統架構

### 2.1 整體架構
```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│   React     │ HTTP │  .NET Core  │ SQL  │ PostgreSQL  │
│   Frontend  │◄────►│   Web API   │◄────►│  Database   │
└─────────────┘      └─────────────┘      └─────────────┘
                            │
                            ▼
                     ┌──────────────┐
                     │ Redis Cache  │
                     └──────────────┘
```

### 2.2 前端架構

#### 2.2.1 技術選型
- **核心框架**: React 18+ (Hooks + Functional Components)
- **狀態管理**: Redux Toolkit / Zustand
- **UI 框架**: Material-UI 
- **表單處理**: React Hook Form + Yup
- **拖拉建立器**: React DnD / dnd-kit
- **HTTP 客戶端**: Axios
- **路由**: React Router v6
- **圖表視覺化**: Recharts / Chart.js
- **富文本編輯器**: Draft.js / Slate

#### 2.2.2 目錄結構
```
frontend/
├── public/
├── src/
│   ├── assets/           # 靜態資源
│   ├── components/       # 可重用元件
│   │   ├── common/      # 通用元件
│   │   ├── form/        # 表單相關元件
│   │   ├── layout/      # 版面元件
│   │   └── project/     # 計畫相關元件
│   ├── features/        # 功能模組
│   │   ├── dashboard/   # 個人儀表板（跨計畫）
│   │   ├── projects/    # 計畫管理
│   │   ├── formBuilder/ # 表單建立器
│   │   ├── formFiller/  # 表單填寫
│   │   ├── dataManager/ # 資料管理
│   │   ├── reports/     # 報告生成
│   │   ├── templates/   # 表單範本
│   │   └── auth/        # 認證授權
│   ├── hooks/           # 自訂 Hooks
│   ├── services/        # API 服務
│   ├── store/           # 狀態管理
│   ├── utils/           # 工具函數
│   ├── types/           # TypeScript 型別定義
│   ├── config/          # 設定檔
│   └── App.tsx          # 根元件
├── package.json
└── tsconfig.json
```

#### 2.2.3 離線模式與 PWA

系統支援 Progressive Web App (PWA)，讓使用者在離線或網路不穩定的環境下仍可填寫表單。

**PWA 功能**

| 功能 | 說明 |
|------|------|
| 可安裝 | 可加入桌面/主畫面，如原生 App |
| 離線存取 | 快取表單結構，離線可瀏覽 |
| 離線填寫 | 離線填寫表單，上線後自動同步 |
| 背景同步 | 使用 Background Sync API |
| 推播通知 | 支援 Web Push Notification |

**離線資料流程**

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   使用者填寫  │────►│ IndexedDB    │────►│ 上線後同步    │
│   表單       │     │ 本地儲存     │     │ 至伺服器     │
└──────────────┘     └──────────────┘     └──────────────┘
                            │
                            ▼
                     ┌──────────────┐
                     │ 衝突處理     │
                     │ (如有必要)   │
                     └──────────────┘
```

**Service Worker 快取策略**

| 資源類型 | 策略 | 說明 |
|----------|------|------|
| App Shell | Cache First | 優先使用快取，背景更新 |
| 表單結構 | Stale While Revalidate | 先回傳快取，同時更新 |
| 表單提交 | Network First | 優先連線，失敗才用本地 |
| 靜態資源 | Cache First | CSS/JS/Images |
| API 資料 | Network First | 即時資料優先網路 |

**離線儲存結構 (IndexedDB)**
```javascript
// 資料庫結構
const db = {
  stores: {
    // 快取的表單結構
    forms: {
      keyPath: 'id',
      indexes: ['projectId', 'updatedAt']
    },
    // 離線提交佇列
    offlineSubmissions: {
      keyPath: 'localId',
      indexes: ['formId', 'status', 'createdAt']
    },
    // 草稿資料
    drafts: {
      keyPath: 'id',  // formId_odraftId
      indexes: ['formId', 'updatedAt']
    },
    // 同步狀態
    syncStatus: {
      keyPath: 'key'
    }
  }
};
```

**離線提交佇列**
```typescript
interface OfflineSubmission {
  localId: string;           // 本地 UUID
  formId: string;
  formVersion: string;
  data: Record<string, any>;
  files: OfflineFile[];      // 檔案以 Base64 暫存
  status: 'pending' | 'syncing' | 'synced' | 'failed';
  createdAt: Date;
  syncedAt?: Date;
  serverId?: string;         // 同步後的伺服器 ID
  errorMessage?: string;
}
```

**同步機制**
```typescript
// 使用 Background Sync API
self.addEventListener('sync', event => {
  if (event.tag === 'sync-submissions') {
    event.waitUntil(syncOfflineSubmissions());
  }
});

// 網路恢復時自動觸發
async function syncOfflineSubmissions() {
  const submissions = await getOfflineSubmissions('pending');

  for (const submission of submissions) {
    try {
      await updateStatus(submission.localId, 'syncing');
      const result = await submitToServer(submission);
      await updateStatus(submission.localId, 'synced', result.id);
      await showNotification('同步成功', `表單已提交`);
    } catch (error) {
      await updateStatus(submission.localId, 'failed', null, error.message);
    }
  }
}
```

**衝突處理**

當表單結構在離線期間更新時：

| 衝突類型 | 處理方式 |
|----------|----------|
| 新增欄位（非必填） | 自動合併，新欄位留空 |
| 新增欄位（必填） | 提示使用者補填 |
| 刪除欄位 | 忽略已填資料，記錄警告 |
| 欄位類型變更 | 嘗試轉換，失敗則提示使用者 |
| 驗證規則變更 | 重新驗證，失敗則提示 |

**離線指示器 UI**
```
┌─────────────────────────────────────┐
│ [🔴 離線模式]  表單將在上線後自動提交 │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ [🟡 同步中]  正在上傳 2 筆離線資料... │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ [🟢 已連線]  所有資料已同步           │
└─────────────────────────────────────┘
```

**PWA Manifest**
```json
{
  "name": "Forma 表單系統",
  "short_name": "Forma",
  "description": "動態表單管理系統",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#1976d2",
  "icons": [
    { "src": "/icons/icon-192.png", "sizes": "192x192", "type": "image/png" },
    { "src": "/icons/icon-512.png", "sizes": "512x512", "type": "image/png" }
  ]
}
```

**技術選型**
- **Service Worker**: Workbox
- **離線儲存**: IndexedDB (Dexie.js 封裝)
- **狀態同步**: 自訂 + Background Sync API
- **網路偵測**: Navigator.onLine + 心跳檢測

### 2.3 後端架構

後端採用 **Clean Architecture（整潔架構）** 設計，確保關注點分離、可測試性和可維護性。

#### 2.3.1 技術選型
- **框架**: ASP.NET Core 8 Web API
- **架構模式**: Clean Architecture + CQRS (可選)
- **ORM**: Entity Framework Core 8
- **認證**: JWT + Identityji3c96u.3gp6ai7ao6vu;32l4
- **授權**: Policy-based Authorization
- **快取**: Redis / IMemoryCache
- **日誌**: Serilog
- **文件生成**: QuestPDF / iTextSharp
- **API 文檔**: Swagger/OpenAPI
- **驗證**: FluentValidation
- **Mapper**: AutoMapper
- **背景工作**: Background Services
- **郵件服務**: FluentEmail / MailKit

#### 2.3.2 Clean Architecture 分層架構

```
┌─────────────────────────────────────────────────────────────┐
│                      Presentation Layer                      │
│                        (Forma.API)                           │
│              Controllers, Middlewares, Filters               │
├─────────────────────────────────────────────────────────────┤
│                     Application Layer                        │
│                    (Forma.Application)                       │
│         Use Cases, DTOs, Validators, Interfaces              │
├─────────────────────────────────────────────────────────────┤
│                       Domain Layer                           │
│                      (Forma.Domain)                          │
│        Entities, Value Objects, Domain Events, Enums         │
├─────────────────────────────────────────────────────────────┤
│                   Infrastructure Layer                       │
│                   (Forma.Infrastructure)                     │
│     EF Core, Repositories, External Services, Email          │
└─────────────────────────────────────────────────────────────┘

依賴方向：外層 → 內層（Domain 層不依賴任何外層）
```

#### 2.3.3 目錄結構
```
backend/
├── src/
│   ├── Forma.API/                    # 展示層 (Presentation)
│   │   ├── Controllers/              # API 控制器
│   │   ├── Middlewares/              # 中介軟體
│   │   ├── Filters/                  # 動作過濾器
│   │   ├── Extensions/               # 服務註冊擴充
│   │   └── Program.cs
│   │
│   ├── Forma.Application/            # 應用層 (Application)
│   │   ├── Common/
│   │   │   ├── Behaviors/            # MediatR Pipeline Behaviors
│   │   │   ├── Interfaces/           # 應用層介面
│   │   │   └── Models/               # 共用模型
│   │   ├── DTOs/                     # 資料傳輸物件
│   │   │   ├── Forms/
│   │   │   ├── Users/
│   │   │   └── Projects/
│   │   ├── Features/                 # 功能模組 (Use Cases)
│   │   │   ├── Forms/
│   │   │   │   ├── Commands/         # 寫入操作
│   │   │   │   │   ├── CreateForm/
│   │   │   │   │   ├── UpdateForm/
│   │   │   │   │   └── DeleteForm/
│   │   │   │   └── Queries/          # 查詢操作
│   │   │   │       ├── GetFormById/
│   │   │   │       └── GetFormsList/
│   │   │   ├── Submissions/
│   │   │   ├── Projects/
│   │   │   ├── Users/
│   │   │   └── Notifications/        # 通知功能
│   │   ├── Services/                 # 應用服務
│   │   ├── Validators/               # FluentValidation 驗證器
│   │   └── Mappings/                 # AutoMapper Profiles
│   │
│   ├── Forma.Domain/                 # 領域層 (Domain)
│   │   ├── Entities/                 # 領域實體
│   │   │   ├── Form.cs
│   │   │   ├── FormSubmission.cs
│   │   │   ├── Project.cs
│   │   │   ├── User.cs
│   │   │   └── Notification.cs
│   │   ├── Enums/                    # 列舉
│   │   │   ├── FormStatus.cs
│   │   │   ├── ProjectRole.cs
│   │   │   └── NotificationType.cs
│   │   ├── ValueObjects/             # 值物件
│   │   │   ├── Email.cs
│   │   │   └── FormSchema.cs
│   │   ├── Events/                   # 領域事件
│   │   │   ├── FormSubmittedEvent.cs
│   │   │   └── FormPublishedEvent.cs
│   │   ├── Interfaces/               # Repository 介面
│   │   │   ├── IFormRepository.cs
│   │   │   ├── ISubmissionRepository.cs
│   │   │   └── IUnitOfWork.cs
│   │   └── Specifications/           # 查詢規格
│   │
│   ├── Forma.Infrastructure/         # 基礎設施層 (Infrastructure)
│   │   ├── Data/
│   │   │   ├── Context/              # DbContext
│   │   │   │   └── FormaDbContext.cs
│   │   │   ├── Configurations/       # Entity 設定
│   │   │   ├── Repositories/         # Repository 實作
│   │   │   └── Migrations/           # 資料庫遷移
│   │   ├── Identity/                 # 身份認證實作
│   │   ├── Caching/                  # 快取實作
│   │   ├── Services/                 # 外部服務實作
│   │   │   ├── EmailService.cs       # 郵件服務
│   │   │   ├── FileStorageService.cs # 檔案儲存
│   │   │   └── BackgroundJobService.cs
│   │   └── DependencyInjection.cs    # DI 註冊
│   │
│   └── Forma.Shared/                 # 共用層 (Cross-Cutting)
│       ├── Constants/                # 常數
│       ├── Exceptions/               # 自訂例外
│       ├── Extensions/               # 擴充方法
│       └── Helpers/                  # 輔助工具
│
└── tests/
    ├── Forma.UnitTests/              # 單元測試
    │   ├── Application/
    │   └── Domain/
    ├── Forma.IntegrationTests/       # 整合測試
    └── Forma.FunctionalTests/        # 功能測試
```

#### 2.3.4 各層職責說明

**Domain Layer (Forma.Domain)**
- 核心業務邏輯和規則
- 完全獨立，不依賴任何外部框架
- 包含實體、值物件、領域事件、Repository 介面

**Application Layer (Forma.Application)**
- 協調領域物件完成業務用例
- 定義 DTOs、驗證規則、應用服務介面
- 使用 MediatR 實作 CQRS 模式（可選）

**Infrastructure Layer (Forma.Infrastructure)**
- 實作所有外部關注點
- 資料庫存取、郵件發送、檔案儲存、第三方服務
- 實作 Application 層定義的介面

**Presentation Layer (Forma.API)**
- HTTP 請求處理
- 認證/授權中介軟體
- API 版本控制、Swagger 文檔

#### 2.3.5 依賴注入配置範例

```csharp
// Program.cs
builder.Services
    .AddApplication()      // Forma.Application
    .AddInfrastructure(    // Forma.Infrastructure
        builder.Configuration
    );

// Forma.Application/DependencyInjection.cs
public static class DependencyInjection
{
    public static IServiceCollection AddApplication(
        this IServiceCollection services)
    {
        services.AddAutoMapper(Assembly.GetExecutingAssembly());
        services.AddValidatorsFromAssembly(Assembly.GetExecutingAssembly());
        services.AddMediatR(cfg => {
            cfg.RegisterServicesFromAssembly(Assembly.GetExecutingAssembly());
            cfg.AddBehavior(typeof(IPipelineBehavior<,>),
                           typeof(ValidationBehavior<,>));
        });
        return services;
    }
}
```

#### 2.3.6 檔案儲存策略

系統支援多種檔案儲存方式，可依部署環境靈活切換。

**儲存提供者**

| 提供者 | 適用場景 | 優點 | 缺點 |
|--------|----------|------|------|
| Local File System | 開發/小型部署 | 簡單、無額外成本 | 不支援水平擴展 |
| Azure Blob Storage | Azure 雲端 | 高可用、CDN 整合 | 需 Azure 訂閱 |
| AWS S3 | AWS 雲端 | 業界標準、功能豐富 | 需 AWS 帳號 |
| MinIO | 私有雲/地端 | S3 相容、可自建 | 需維護基礎設施 |

**抽象介面設計**
```csharp
public interface IFileStorageService
{
    Task<FileUploadResult> UploadAsync(
        Stream stream,
        string fileName,
        string contentType,
        CancellationToken ct = default);

    Task<Stream> DownloadAsync(string fileKey, CancellationToken ct = default);
    Task<string> GetPresignedUrlAsync(string fileKey, TimeSpan expiry);
    Task DeleteAsync(string fileKey, CancellationToken ct = default);
    Task<bool> ExistsAsync(string fileKey, CancellationToken ct = default);
}

public record FileUploadResult(
    string FileKey,
    string OriginalName,
    string ContentType,
    long Size,
    string Url
);
```

**檔案存放結構**
```
storage/
├── forms/
│   └── {formId}/
│       └── submissions/
│           └── {submissionId}/
│               ├── {fieldName}_{uuid}.pdf
│               └── {fieldName}_{uuid}.jpg
├── signatures/
│   └── {submissionId}_{fieldId}.png
├── templates/
│   └── {templateId}/
│       └── thumbnail.png
└── exports/
    └── {userId}/
        └── {exportId}.xlsx
```

**安全性考量**

| 安全措施 | 說明 |
|----------|------|
| 預簽名 URL | 下載連結限時有效（預設 15 分鐘） |
| 檔案類型驗證 | 白名單 + Magic Number 檢查 |
| 檔案大小限制 | 可依欄位設定上限 |
| 病毒掃描 | 整合 ClamAV（可選） |
| 存取控制 | 依表單權限檢查 |

**組態設定**
```json
// appsettings.json
{
  "FileStorage": {
    "Provider": "AzureBlob",  // "Local" | "AzureBlob" | "S3" | "MinIO"
    "Local": {
      "BasePath": "./uploads"
    },
    "AzureBlob": {
      "ConnectionString": "...",
      "ContainerName": "forma-files"
    },
    "S3": {
      "AccessKey": "...",
      "SecretKey": "...",
      "BucketName": "forma-files",
      "Region": "ap-northeast-1"
    },
    "Settings": {
      "MaxFileSizeMB": 50,
      "AllowedExtensions": [".pdf", ".doc", ".docx", ".xls", ".xlsx", ".jpg", ".png"],
      "PresignedUrlExpiryMinutes": 15
    }
  }
}
```

**大檔案上傳處理**
- 小於 5MB：直接上傳
- 5MB ~ 100MB：分片上傳 (Multipart Upload)
- 大於 100MB：需管理員特別授權

```
// 分片上傳 API
POST   /api/files/upload/init          # 初始化分片上傳
PUT    /api/files/upload/{uploadId}/part/{partNumber}  # 上傳分片
POST   /api/files/upload/{uploadId}/complete  # 完成上傳
DELETE /api/files/upload/{uploadId}    # 取消上傳
```

### 2.4 資料庫設計

#### 2.4.1 核心資料表

**Users (使用者表)**
- Id (PK)
- Username
- Email
- PasswordHash
- SystemRole (Enum: SystemAdmin, Auditor, User)
- Department (部門)
- JobTitle (職稱)
- PhoneNumber
- IsActive
- CreatedAt
- UpdatedAt
- LastLoginAt

**Organizations (組織表)**
- Id (PK)
- Name
- Code (組織代碼)
- Description
- Type (中央/地方政府)
- CreatedAt
- UpdatedAt

**Projects (計畫表)**
- Id (PK)
- OrganizationId (FK)
- Name (計畫名稱)
- Code (計畫代碼)
- Description
- Year (年度)
- Budget (預算)
- StartDate
- EndDate
- Status (Draft/Active/Completed/Archived)
- CreatedBy (FK)
- CreatedAt
- UpdatedAt

**ProjectMembers (計畫成員表)**
- Id (PK)
- ProjectId (FK)
- UserId (FK)
- Role (Enum: Owner, Manager, Member, Analyst, Submitter)
- AddedBy (FK)
- AddedAt
- RemovedAt (nullable)

**Forms (表單表)**
- Id (PK)
- ProjectId (FK)
- Name
- Description
- Schema (JSONB) - 表單結構定義
- TemplateId (FK, nullable)
- CreatedBy (FK)
- CreatedAt
- UpdatedAt
- PublishedAt
- IsActive
- Version
- AccessControl (Public/Private/Restricted)

**FormSubmissions (表單提交記錄)**
- Id (PK)
- FormId (FK)
- ProjectId (FK)
- SubmittedBy (FK, nullable) - 匿名提交可為 null
- SubmissionData (JSONB)
- SubmittedAt
- UpdatedAt
- Status (Draft/Submitted/Reviewed/Approved/Rejected)
- ReviewedBy (FK, nullable)
- ReviewedAt (nullable)
- IpAddress

**FormTemplates (表單範本)**
- Id (PK)
- Name
- Description
- Category
- Schema (JSONB)
- ThumbnailUrl
- IsPublic
- CreatedBy (FK)
- CreatedAt
- UsageCount

**FormPermissions (表單權限表)**
- Id (PK)
- FormId (FK)
- UserId (FK, nullable) - 特定使用者
- ProjectMemberRole (Enum, nullable) - 或特定角色
- PermissionType (View/Edit/Submit/Manage)
- GrantedBy (FK)
- GrantedAt

**Reports (報告表)**
- Id (PK)
- FormId (FK)
- Name
- Configuration (JSONB)
- CreatedBy (FK)
- CreatedAt
- UpdatedAt

**AuditLogs (審計日誌)**
- Id (PK)
- UserId (FK)
- Action
- EntityType
- EntityId
- Changes (JSONB)
- Timestamp
- IpAddress

---

## 3. 核心功能模組

### 3.1 使用者儀表板（跨計畫功能）

#### 功能描述
為使用者提供統一的工作介面，集中管理所有參與的計畫。

#### 核心功能
**我的計畫**
- 顯示所有參與的計畫列表
- 依角色分類（我管理的計畫 / 我參與的計畫）
- 計畫狀態和進度一覽
- 快速切換計畫
- 計畫搜尋和篩選

**跨計畫統計**
- 我負責的所有表單總數
- 待審核的提交數量（跨所有計畫）
- 近期活動時間軸
- 個人工作量統計

**待辦事項中心**
- 待審核的表單提交（跨計畫彙整）
- 指派給我的任務
- 即將到期的計畫
- 需要處理的通知

**快速操作**
- 最近訪問的計畫
- 常用表單
- 快速建立表單
- 快速查詢提交

**個人統計報告**
- 經理可查看管理的所有計畫統計
- 成員可查看參與的所有計畫貢獻
- 匯出個人工作報告

#### 實作重點
- 前端使用計畫上下文切換機制
- API 支援跨計畫查詢（帶權限過濾）
- 使用 Redis 快取使用者的計畫列表

### 3.2 動態表單建立器

#### 功能描述
提供拖拉式介面讓使用者設計自訂表單。

#### 支援元件類型
- 文字輸入 (單行/多行)
- 數字輸入
- 日期/時間選擇器
- 下拉選單 (單選/多選)
- 單選按鈕
- 核取方塊
- 檔案上傳
- 評分元件
- 矩陣問題
- 區段/分頁
- 簽名欄位

#### 元件屬性
- 標籤文字
- 說明提示
- 必填/選填
- 驗證規則
- 預設值
- 條件顯示邏輯
- 樣式自訂

#### 技術實作
- JSON Schema 儲存表單結構
- 前端使用 React DnD 實現拖拉
- 即時預覽功能
- 版本控制機制

#### 3.2.1 表單版本管理

表單在發布後若有修改，系統自動建立新版本，確保舊提交資料與對應的表單結構一致。

**版本控制策略**

| 操作類型 | 版本變化 | 說明 |
|----------|----------|------|
| 儲存草稿 | 不變 | 僅更新草稿內容 |
| 發布表單 | Minor +1 | 1.0 → 1.1 |
| 結構性修改後發布 | Major +1 | 1.x → 2.0 |
| 複製表單 | 重置為 1.0 | 新表單獨立版本線 |

**結構性修改定義**
- 新增/刪除欄位
- 修改欄位類型
- 修改欄位 name（識別鍵）
- 修改驗證規則

**版本資料結構**
```json
{
  "formId": "form_001",
  "versions": [
    {
      "version": "1.0",
      "schema": { ... },
      "publishedAt": "2026-01-15T10:00:00Z",
      "publishedBy": "user_123",
      "changeLog": "初始版本"
    },
    {
      "version": "1.1",
      "schema": { ... },
      "publishedAt": "2026-01-20T14:30:00Z",
      "publishedBy": "user_123",
      "changeLog": "新增電話欄位",
      "changes": [
        { "type": "add", "field": "phone", "path": "pages[0].fields[3]" }
      ]
    }
  ],
  "currentVersion": "1.1",
  "draftSchema": { ... }
}
```

**版本相關 API**
```
GET    /api/forms/{id}/versions           # 取得版本列表
GET    /api/forms/{id}/versions/{ver}     # 取得特定版本
POST   /api/forms/{id}/versions/{ver}/restore  # 還原至特定版本
GET    /api/forms/{id}/versions/compare?v1=1.0&v2=1.1  # 版本差異比較
```

**提交資料與版本關聯**
```sql
-- FormSubmissions 表增加欄位
FormVersion VARCHAR(10) NOT NULL  -- 記錄提交時的表單版本
```

#### 3.2.2 表單排程

支援表單的定時發布、定時關閉、限時填寫等排程功能。

**排程類型**

| 類型 | 說明 | 使用場景 |
|------|------|----------|
| `scheduled_publish` | 定時發布 | 活動報名於指定時間開放 |
| `scheduled_close` | 定時關閉 | 截止日期自動停止收件 |
| `time_window` | 時段限制 | 僅在特定時段可填寫 |
| `quota_limit` | 名額限制 | 達到上限自動關閉 |

**排程設定結構**
```json
{
  "scheduling": {
    "publishAt": "2026-02-01T09:00:00+08:00",
    "closeAt": "2026-02-28T23:59:59+08:00",
    "timezone": "Asia/Taipei",
    "quotaLimit": {
      "enabled": true,
      "maxSubmissions": 100,
      "showRemaining": true,
      "closedMessage": "報名已額滿"
    },
    "timeWindows": [
      {
        "dayOfWeek": [1, 2, 3, 4, 5],
        "startTime": "09:00",
        "endTime": "18:00"
      }
    ],
    "closedMessage": "表單目前未開放填寫",
    "notYetOpenMessage": "表單尚未開放，敬請期待"
  }
}
```

**排程狀態機**
```
                    ┌─────────────┐
        publishAt   │             │  closeAt/quota
    ┌───────────────►   Active    ├───────────────┐
    │               │             │               │
    │               └──────┬──────┘               │
    │                      │                      ▼
┌───┴────┐            manual            ┌─────────────┐
│Scheduled│◄───────────────────────────►│   Closed    │
└────────┘            toggle            └─────────────┘
```

**背景排程工作**
```csharp
// 每分鐘檢查排程
RecurringJob.AddOrUpdate<IFormSchedulingService>(
    "form-scheduling",
    x => x.ProcessScheduledFormsAsync(),
    "* * * * *");  // 每分鐘執行
```

#### 3.2.3 表單複製與繼承

**表單複製**

快速從現有表單建立新表單，可選擇複製項目：

| 複製項目 | 預設 | 說明 |
|----------|------|------|
| Schema（結構） | ✓ | 欄位定義 |
| Settings（設定） | ✓ | 表單設定 |
| Theme（主題） | ✓ | 視覺樣式 |
| Permissions（權限） | ✗ | 權限設定 |
| Scheduling（排程） | ✗ | 排程設定 |

```json
// POST /api/forms/{id}/clone
{
  "newName": "2026年度員工滿意度調查",
  "targetProjectId": "project_456",
  "include": {
    "schema": true,
    "settings": true,
    "theme": true,
    "permissions": false,
    "scheduling": false
  }
}
```

**表單範本繼承**

建立表單時可選擇範本，並設定是否「鎖定」範本欄位：

```json
{
  "templateId": "template_001",
  "inheritance": {
    "mode": "extend",  // "extend" | "override" | "locked"
    "lockedFields": ["name", "email", "phone"],  // 不可修改的欄位
    "syncUpdates": true  // 範本更新時自動同步
  }
}
```

| 繼承模式 | 說明 |
|----------|------|
| `extend` | 可新增欄位，不可修改/刪除範本欄位 |
| `override` | 完全複製，與範本脫鉤 |
| `locked` | 完全鎖定，僅能填寫 |

### 3.3 表單填寫與提交

#### 功能描述
終端使用者填寫已發布的表單並提交資料。

#### 核心功能
- 響應式表單渲染
- 即時驗證
- 草稿儲存
- 進度追蹤
- 檔案上傳處理
- 防重複提交
- 匿名/登入提交
- 多語系支援

#### 3.2.1 表單顯示模式

系統支援兩種表單填寫介面模式，可根據裝置類型自動切換或由使用者選擇：

**卡片模式 (Card Mode)** - 參考 Formbricks 風格
- 一次顯示一個問題
- 卡片堆疊視覺效果，營造進度感
- 大按鈕、大字體，觸控友善
- 滑動/點擊切換下一題
- 適合：手機、平板、觸控螢幕、簡短問卷
- 優點：專注度高、視覺現代、行動裝置體驗佳
- 缺點：長表單需多次操作、無法快速總覽

**經典模式 (Classic Mode)** - 參考 SurveyJS 風格
- 一頁顯示多個問題（或整個區段）
- 傳統表單垂直排列
- 支援多欄位並排佈局
- 可捲動瀏覽所有欄位
- 適合：桌面電腦、複雜表單、資料輸入密集場景
- 優點：總覽性強、填寫效率高、適合熟練使用者
- 缺點：行動裝置體驗較差、視覺較傳統

**混合模式 (Hybrid Mode)**
- 根據螢幕寬度自動切換
- 手機/平板 (< 768px)：自動使用卡片模式
- 桌面 (>= 768px)：自動使用經典模式
- 使用者可手動切換偏好模式

#### 3.2.2 顯示模式設定

```json
{
  "settings": {
    "displayMode": {
      "default": "hybrid",
      "allowUserSwitch": true,
      "cardMode": {
        "showProgressBar": true,
        "showQuestionNumber": true,
        "animation": "slide",
        "stackedCards": 3
      },
      "classicMode": {
        "questionsPerPage": "section",
        "showAllValidationErrors": true,
        "stickyNavigation": true
      }
    }
  }
}
```

**設定參數說明**

| 參數 | 說明 | 預設值 |
|------|------|--------|
| `default` | 預設模式：`card`、`classic`、`hybrid` | `hybrid` |
| `allowUserSwitch` | 允許使用者切換模式 | `true` |

**卡片模式專屬設定 (cardMode)**

| 參數 | 說明 | 預設值 |
|------|------|--------|
| `showProgressBar` | 顯示進度條 | `true` |
| `showQuestionNumber` | 顯示題號 | `true` |
| `animation` | 切換動畫：`slide`、`fade`、`none` | `slide` |
| `stackedCards` | 堆疊卡片數量（視覺效果） | `3` |
| `autoAdvance` | 選擇後自動進入下一題（適用單選題） | `false` |

**經典模式專屬設定 (classicMode)**

| 參數 | 說明 | 預設值 |
|------|------|--------|
| `questionsPerPage` | 每頁顯示：`all`（全部）、`section`（按區段）、數字 | `section` |
| `showAllValidationErrors` | 提交時顯示所有驗證錯誤 | `true` |
| `stickyNavigation` | 固定導覽列 | `true` |
| `columnLayout` | 支援多欄佈局 | `true` |

#### 3.2.3 UI 元件設計原則

**卡片模式 UI 元件**
```
┌─────────────────────────────────┐
│  ← 返回                    3/10 │  ← 進度指示
├─────────────────────────────────┤
│  ████████░░░░░░░░░░░░░░░░░░░░  │  ← 進度條
├─────────────────────────────────┤
│                                 │
│    Q3. 您的年齡範圍是？         │  ← 問題標題
│                                 │
│    ┌─────────────────────┐     │
│    │  ○ 18-25 歲          │     │
│    ├─────────────────────┤     │
│    │  ○ 26-35 歲          │     │  ← 選項卡片
│    ├─────────────────────┤     │
│    │  ○ 36-45 歲          │     │
│    ├─────────────────────┤     │
│    │  ○ 46 歲以上         │     │
│    └─────────────────────┘     │
│                                 │
├─────────────────────────────────┤
│        [ 下一題 → ]             │  ← 導覽按鈕
└─────────────────────────────────┘
     ┌───────────────────┐
     │    (堆疊卡片)      │         ← 視覺暗示還有更多問題
     └───────────────────┘
```

**經典模式 UI 元件**
```
┌──────────────────────────────────────────────────────┐
│  表單標題                              [卡片模式切換] │
│  ████████████░░░░░░░░░░░░░░░░░░░░░░░░  30% 完成     │
├──────────────────────────────────────────────────────┤
│                                                      │
│  第一區段：基本資料                                   │
│  ─────────────────────────────────────────────────── │
│                                                      │
│  姓名 *                    電子郵件 *                │
│  ┌──────────────┐         ┌──────────────┐         │
│  │              │         │              │         │
│  └──────────────┘         └──────────────┘         │
│                                                      │
│  電話                      部門                      │
│  ┌──────────────┐         ┌──────────────▼┐        │
│  │              │         │ 請選擇...     │        │
│  └──────────────┘         └───────────────┘        │
│                                                      │
│  ─────────────────────────────────────────────────── │
│  第二區段：問題回饋                                   │
│  ...                                                 │
│                                                      │
├──────────────────────────────────────────────────────┤
│  [上一頁]                              [下一頁]      │
└──────────────────────────────────────────────────────┘
```

#### 3.2.4 響應式斷點設計

| 斷點 | 螢幕寬度 | 建議模式 | 佈局調整 |
|------|----------|----------|----------|
| `xs` | < 576px | 卡片模式 | 單欄、全寬按鈕 |
| `sm` | 576-767px | 卡片模式 | 單欄、較大觸控區 |
| `md` | 768-991px | 混合可選 | 可單/雙欄 |
| `lg` | 992-1199px | 經典模式 | 雙欄佈局 |
| `xl` | >= 1200px | 經典模式 | 多欄佈局、側邊導覽 |

#### 3.2.5 模式切換技術實作

```typescript
// 模式切換 Hook 範例
const useDisplayMode = (settings: DisplayModeSettings) => {
  const [mode, setMode] = useState(settings.default);
  const screenWidth = useScreenWidth();

  useEffect(() => {
    if (settings.default === 'hybrid') {
      setMode(screenWidth < 768 ? 'card' : 'classic');
    }
  }, [screenWidth]);

  const toggleMode = () => {
    if (settings.allowUserSwitch) {
      setMode(mode === 'card' ? 'classic' : 'card');
    }
  };

  return { mode, toggleMode, canSwitch: settings.allowUserSwitch };
};
```

#### 3.2.6 複雜題型的響應式處理

某些題型在卡片模式（小螢幕）下需要特殊處理，以確保良好的使用體驗：

**矩陣題 (matrix) 的響應式策略**

| 策略 | 說明 | 適用情境 |
|------|------|----------|
| `stack` | 逐行堆疊顯示，每行變成獨立卡片 | 行數較多的矩陣 |
| `dropdown` | 將列選項轉為下拉選單 | 列數較多的矩陣 |
| `accordion` | 折疊式顯示，點擊展開各行 | 行數多且需要詳細說明 |
| `scroll` | 保持原始表格，允許水平捲動 | 使用者熟悉表格操作 |
| `forceClassic` | 強制切換至經典模式顯示此題 | 複雜矩陣無法簡化 |

**矩陣題堆疊模式示意 (stack)**
```
原始矩陣：
         | 非常同意 | 同意 | 普通 | 不同意 |
服務態度  |    ○    |  ○  |  ○  |   ○   |
產品品質  |    ○    |  ○  |  ○  |   ○   |
價格合理  |    ○    |  ○  |  ○  |   ○   |

卡片模式堆疊顯示：
┌─────────────────────────────┐
│ Q1. 服務態度                 │  ← 第一行變成獨立問題
│                             │
│  ○ 非常同意                 │
│  ○ 同意                     │
│  ○ 普通                     │
│  ○ 不同意                   │
└─────────────────────────────┘
       ↓ 下一張卡片
┌─────────────────────────────┐
│ Q2. 產品品質                 │
│  ...                        │
└─────────────────────────────┘
```

**矩陣題下拉模式示意 (dropdown)**
```
┌─────────────────────────────┐
│ 請評分以下各項：              │
│                             │
│ 服務態度                     │
│ ┌─────────────────────▼┐   │
│ │ 請選擇...             │   │
│ └───────────────────────┘   │
│                             │
│ 產品品質                     │
│ ┌─────────────────────▼┐   │
│ │ 請選擇...             │   │
│ └───────────────────────┘   │
└─────────────────────────────┘
```

**各題型的響應式處理對照表**

| 題型 | 卡片模式處理 | 預設策略 |
|------|-------------|----------|
| `matrix` | 堆疊/下拉/折疊 | `stack` |
| `matrixdropdown` | 堆疊顯示，每行一卡 | `stack` |
| `matrixdynamic` | 強制經典模式 | `forceClassic` |
| `multipletext` | 垂直堆疊各輸入框 | 自動調整 |
| `ranking` | 保持原樣（拖拉排序） | 原生支援 |
| `paneldynamic` | 每個項目一張卡片 | `stack` |
| `signature` | 全寬顯示，調整高度 | 自動調整 |

**欄位層級的顯示模式覆寫**

可在欄位定義中覆寫特定欄位的響應式行為：

```json
{
  "id": "satisfaction_matrix",
  "type": "matrix",
  "name": "satisfaction",
  "label": "滿意度評估",
  "properties": {
    "rows": [...],
    "columns": [...],
    "responsiveMode": {
      "mobile": "dropdown",
      "tablet": "scroll",
      "desktop": "default"
    }
  }
}
```

**強制經典模式的題型群組**

對於無法在卡片模式良好呈現的題型組合，可設定整個區段強制使用經典模式：

```json
{
  "id": "page_complex",
  "title": "複雜評估區段",
  "forceDisplayMode": "classic",
  "fields": [
    { "type": "matrixdynamic", ... },
    { "type": "matrixdropdown", ... }
  ]
}
```

#### 提交流程
1. 前端驗證
2. 資料序列化
3. API 提交
4. 後端驗證
5. 資料庫儲存
6. 回應確認

### 3.3 資料收集與管理

#### 功能描述
管理和檢視所有表單提交的資料。

#### 核心功能
- 提交記錄列表
- 篩選與搜尋
- 排序功能
- 分頁載入
- 詳細檢視
- 資料編輯（依權限）
- 批次操作
- 資料統計

#### 資料檢視方式
- 表格檢視
- 卡片檢視
- 時間軸檢視
- 統計圖表

### 3.4 權限控制

#### 3.4.1 權限架構層級

```
組織 (Organization)
  ├── 系統管理員 (System Admin)
  └── 稽核員 (Auditor)

計畫 (Project)
  ├── 計畫擁有者 (Project Owner)
  ├── 計畫經理 (Project Manager)
  ├── 計畫成員 (Project Member)
  ├── 資料分析師 (Data Analyst)
  └── 提交者 (Submitter)

表單 (Form)
  └── 細粒度權限設定
```

#### 3.4.2 系統層級角色

**系統管理員 (System Admin)**
- 管理所有組織和計畫
- 使用者管理
- 系統設定
- 檢視所有審計日誌

**稽核員 (Auditor)**
- 唯讀所有計畫資料
- 檢視審計日誌
- 匯出稽核報告
- 不能修改任何資料

#### 3.4.3 計畫層級角色

**重要說明**：使用者可以同時參與多個計畫，並在每個計畫中擔任不同的角色。例如：
- 使用者 A 可以在計畫 1 擔任 Manager，在計畫 2 擔任 Member
- 使用者 B 可以同時管理計畫 3、4、5

**計畫擁有者 (Project Owner)**
- 建立計畫的人
- 完全控制計畫
- 指派/移除計畫經理和成員
- 刪除計畫
- 設定計畫層級權限

**計畫經理 (Project Manager)**
權限包含：
- 管理計畫基本資訊
- 新增/移除計畫成員（不包含其他經理）
- 建立/編輯/刪除表單
- 發布/下架表單
- 查看所有表單提交資料
- 審核提交資料
- 指派表單權限
- 匯出資料和報告
- 建立報告範本
- 查看自己管理的所有計畫統計

**計畫成員 (Project Member)**
權限包含：
- 查看計畫資訊
- 建立/編輯自己建立的表單
- 查看指派給自己的表單
- 查看自己負責的表單提交資料
- 匯出自己權限範圍內的資料
- 建立草稿報告
- 查看自己所有參與計畫的待辦事項

**資料分析師 (Data Analyst)**
權限包含：
- 唯讀所有計畫資料
- 查看所有表單和提交
- 建立和匯出報告
- 查看統計儀表板
- 不能建立或修改表單

**提交者 (Submitter)**
權限包含：
- 查看公開表單
- 填寫和提交表單
- 查看/編輯自己的提交（依表單設定）
- 不能查看其他人的提交

#### 3.4.4 表單層級權限

每個表單可以額外設定：
- **公開表單**: 任何人都可填寫（包含匿名）
- **計畫內部**: 僅計畫成員可填寫
- **指定角色**: 指定特定計畫角色可填寫
- **指定使用者**: 指定特定使用者可填寫

表單操作權限：
- **View**: 查看表單設計
- **Submit**: 提交表單
- **ViewSubmissions**: 查看提交資料
- **Edit**: 編輯表單設計
- **Manage**: 完整管理權限

#### 3.4.5 權限矩陣

| 功能 | Owner | Manager | Member | Analyst | Submitter |
|------|-------|---------|--------|---------|----------|
| 管理計畫資訊 | ✓ | ✓ | - | - | - |
| 新增成員 | ✓ | ✓* | - | - | - |
| 建立表單 | ✓ | ✓ | ✓** | - | - |
| 編輯所有表單 | ✓ | ✓ | - | - | - |
| 編輯自己的表單 | ✓ | ✓ | ✓ | - | - |
| 刪除表單 | ✓ | ✓ | ✓** | - | - |
| 發布表單 | ✓ | ✓ | - | - | - |
| 查看所有提交 | ✓ | ✓ | - | ✓ | - |
| 查看指派提交 | ✓ | ✓ | ✓ | ✓ | - |
| 查看自己提交 | ✓ | ✓ | ✓ | ✓ | ✓ |
| 審核提交 | ✓ | ✓ | ✓*** | - | - |
| 匯出資料 | ✓ | ✓ | ✓**** | ✓ | - |
| 建立報告 | ✓ | ✓ | ✓ | ✓ | - |
| 管理權限 | ✓ | ✓ | - | - | - |
| 刪除計畫 | ✓ | - | - | - | - |

\* Manager 不能新增/移除其他 Manager  
\*\* 僅限自己建立的表單  
\*\*\* 僅限指派給自己的表單  
\*\*\*\* 僅限自己權限範圍內的資料

#### 3.4.6 實作方式

**認證機制**
- JWT Token (Access Token + Refresh Token)
- Token 有效期：Access 15分鐘，Refresh 7天
- 政府單位可整合 LDAP/AD

**授權機制**
- Policy-based Authorization
- Resource-based Authorization
- 多層級權限檢查（系統 → 計畫 → 表單）

**權限檢查流程**
1. 驗證使用者身份（JWT）
2. 檢查系統層級權限
3. 檢查計畫成員資格
4. 檢查計畫內角色
5. 檢查表單層級權限
6. 檢查資源擁有者

**權限快取**
- 使用 Redis 快取使用者權限
- 權限變更時立即清除快取
- 快取有效期 5 分鐘

### 3.5 資料匯出入

#### 3.5.1 資料匯出

**支援格式**
- Excel (.xlsx)
- CSV
- JSON
- PDF

**匯出選項**
- 全部資料
- 篩選後資料
- 選擇欄位
- 日期範圍
- 包含附件

**技術實作**
- 後端生成檔案
- 串流下載
- 背景工作處理大量資料
- 匯出歷史記錄

#### 3.5.2 資料匯入

支援從 Excel/CSV 批次匯入提交資料，適用於歷史資料遷移、離線資料收集等場景。

**匯入流程**

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ 上傳檔案 │───►│ 欄位映射 │───►│ 資料驗證 │───►│ 預覽確認 │───►│ 執行匯入 │
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
                    │              │              │
                    ▼              ▼              ▼
               自動偵測       顯示錯誤       可編輯修正
               手動調整       警告統計
```

**欄位映射設定**
```json
{
  "formId": "form_001",
  "fileFormat": "xlsx",
  "mapping": {
    "columns": [
      { "source": "A", "sourceHeader": "姓名", "target": "name", "required": true },
      { "source": "B", "sourceHeader": "Email", "target": "email", "required": true },
      { "source": "C", "sourceHeader": "部門", "target": "department", "required": false },
      { "source": "D", "sourceHeader": "提交日期", "target": "_submittedAt", "format": "YYYY/MM/DD" }
    ],
    "startRow": 2,
    "hasHeader": true
  },
  "options": {
    "skipDuplicates": true,
    "duplicateCheckFields": ["email"],
    "onError": "skip",  // "skip" | "abort" | "collect"
    "defaultValues": {
      "source": "import"
    }
  }
}
```

**匯入驗證**

| 驗證項目 | 說明 |
|----------|------|
| 格式驗證 | 檢查資料類型是否符合欄位定義 |
| 必填檢查 | 必填欄位不可為空 |
| 唯一性檢查 | 依設定檢查重複資料 |
| 關聯驗證 | 選項值是否在允許範圍內 |
| 自訂規則 | 套用表單定義的驗證規則 |

**匯入結果報告**
```json
{
  "importId": "import_001",
  "status": "completed",
  "summary": {
    "totalRows": 500,
    "successCount": 485,
    "skipCount": 10,
    "errorCount": 5
  },
  "errors": [
    {
      "row": 15,
      "field": "email",
      "value": "invalid-email",
      "error": "Invalid email format"
    }
  ],
  "createdSubmissionIds": ["sub_001", "sub_002", "..."]
}
```

**匯入 API**
```
POST   /api/forms/{id}/import/upload    # 上傳匯入檔案
POST   /api/forms/{id}/import/mapping   # 設定欄位映射
GET    /api/forms/{id}/import/preview   # 預覽匯入資料
POST   /api/forms/{id}/import/execute   # 執行匯入
GET    /api/forms/{id}/import/{importId}/status  # 查詢匯入狀態
GET    /api/forms/{id}/import/history   # 匯入歷史記錄
POST   /api/forms/{id}/import/{importId}/rollback  # 回滾匯入
```

**匯入範本下載**
- 提供空白範本 Excel，含欄位標題與格式說明
- 提供範例資料範本
```
GET    /api/forms/{id}/import/template  # 下載匯入範本
```

### 3.6 報告生成

#### 報告類型
- 統計報告
- 彙總報告
- 趨勢分析
- 自訂報告

#### 視覺化元件
- 長條圖
- 圓餅圖
- 折線圖
- 熱力圖
- 資料表格

#### 功能特性
- 報告範本
- 定期自動生成
- 報告分享
- PDF 匯出
- 儀表板展示

### 3.7 表單範本

#### 功能描述
提供預設範本加速表單建立。

#### 範本分類
- 問卷調查
- 註冊表單
- 回饋表單
- 申請表單
- 訂單表單
- 客製範本

#### 範本管理
- 範本市集
- 自訂範本儲存
- 範本分享
- 範本複製
- 範本評分

### 3.8 通知系統

#### 功能描述
提供多管道通知功能，支援 Email、系統內通知、Webhook 等方式，在關鍵事件發生時通知相關使用者。

#### 3.8.1 通知類型

| 類型 | 說明 | 預設管道 |
|------|------|----------|
| `form_submitted` | 表單已提交 | Email + 系統 |
| `form_published` | 表單已發布 | 系統 |
| `submission_reviewed` | 提交已審核 | Email + 系統 |
| `submission_approved` | 提交已核准 | Email |
| `submission_rejected` | 提交已退回 | Email |
| `project_invitation` | 計畫邀請 | Email + 系統 |
| `deadline_reminder` | 截止日提醒 | Email |
| `mention` | 被提及 | 系統 |
| `export_ready` | 匯出完成 | 系統 |

#### 3.8.2 通知管道

**Email 通知**
- SMTP 伺服器整合
- 支援 SendGrid、AWS SES、自建 SMTP
- HTML 郵件範本（支援多語系）
- 郵件佇列處理（避免阻塞主執行緒）
- 退信處理與記錄

**系統內通知**
- 即時推播（SignalR）
- 通知中心（未讀/已讀管理）
- 通知偏好設定

**Webhook (可選)**
- 自訂 HTTP 回呼
- 支援第三方整合（Slack、Teams、Line Notify）

#### 3.8.3 Email 服務架構

```
┌─────────────────────────────────────────────────────────────┐
│                     Application Layer                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  INotificationService                                │   │
│  │  - SendAsync(notification)                          │   │
│  │  - SendEmailAsync(to, template, data)               │   │
│  │  - SendBulkEmailAsync(recipients, template, data)   │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│                   Infrastructure Layer                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  EmailService : IEmailService                        │   │
│  │  - Uses FluentEmail / MailKit                        │   │
│  │  - Template rendering (Razor / Liquid)               │   │
│  │  - Queue integration (Hangfire)                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                  │
│                           ▼                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Email Providers                                     │   │
│  │  - SmtpEmailSender                                   │   │
│  │  - SendGridEmailSender                               │   │
│  │  - AwsSesEmailSender                                 │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

#### 3.8.4 Email 範本系統

**範本結構**
```
Infrastructure/
└── Services/
    └── Email/
        ├── Templates/
        │   ├── _Layout.cshtml           # 共用版面
        │   ├── FormSubmitted.cshtml     # 表單提交通知
        │   ├── SubmissionReviewed.cshtml
        │   ├── ProjectInvitation.cshtml
        │   └── DeadlineReminder.cshtml
        └── EmailTemplateService.cs
```

**範本範例 (Razor)**
```html
@model FormSubmittedEmailModel

<h2>表單提交通知</h2>
<p>您好 @Model.RecipientName，</p>
<p>
  表單「<strong>@Model.FormTitle</strong>」收到一筆新的提交。
</p>
<table>
  <tr>
    <td>提交者：</td>
    <td>@Model.SubmitterName</td>
  </tr>
  <tr>
    <td>提交時間：</td>
    <td>@Model.SubmittedAt.ToString("yyyy/MM/dd HH:mm")</td>
  </tr>
</table>
<p>
  <a href="@Model.ViewSubmissionUrl">查看提交內容</a>
</p>
```

#### 3.8.5 通知偏好設定

使用者可自訂各類通知的接收方式：

```json
{
  "userId": "user_123",
  "preferences": {
    "form_submitted": {
      "email": true,
      "inApp": true,
      "digest": "immediate"
    },
    "submission_reviewed": {
      "email": true,
      "inApp": true,
      "digest": "immediate"
    },
    "deadline_reminder": {
      "email": true,
      "inApp": false,
      "advanceDays": [7, 3, 1]
    },
    "mention": {
      "email": false,
      "inApp": true
    }
  },
  "quietHours": {
    "enabled": true,
    "start": "22:00",
    "end": "08:00",
    "timezone": "Asia/Taipei"
  },
  "emailDigest": {
    "enabled": true,
    "frequency": "daily",
    "time": "09:00"
  }
}
```

| 設定 | 說明 |
|------|------|
| `digest` | 通知頻率：`immediate`（即時）、`hourly`、`daily` |
| `quietHours` | 勿擾時段，期間累積通知延後發送 |
| `emailDigest` | Email 摘要，彙整多則通知為單一郵件 |

#### 3.8.6 領域事件驅動通知

利用 Domain Events 觸發通知，確保解耦：

```csharp
// Domain Event
public record FormSubmittedEvent(
    Guid FormId,
    Guid SubmissionId,
    Guid? SubmitterId,
    DateTime SubmittedAt
) : IDomainEvent;

// Event Handler (Application Layer)
public class FormSubmittedEventHandler
    : INotificationHandler<FormSubmittedEvent>
{
    private readonly INotificationService _notificationService;
    private readonly IFormRepository _formRepository;

    public async Task Handle(
        FormSubmittedEvent notification,
        CancellationToken cancellationToken)
    {
        var form = await _formRepository
            .GetByIdAsync(notification.FormId);

        // 通知表單建立者
        await _notificationService.SendAsync(new Notification
        {
            Type = NotificationType.FormSubmitted,
            RecipientId = form.CreatedBy,
            Data = new
            {
                FormId = form.Id,
                FormTitle = form.Name,
                SubmissionId = notification.SubmissionId,
                SubmittedAt = notification.SubmittedAt
            }
        });
    }
}
```

#### 3.8.7 背景工作排程

使用 Hangfire 處理郵件發送和定期任務：

```csharp
// 即時郵件（加入佇列）
BackgroundJob.Enqueue<IEmailService>(
    x => x.SendAsync(email));

// 延遲郵件
BackgroundJob.Schedule<IEmailService>(
    x => x.SendAsync(email),
    TimeSpan.FromMinutes(5));

// 定期任務：截止日提醒
RecurringJob.AddOrUpdate<IDeadlineReminderService>(
    "deadline-reminder",
    x => x.SendRemindersAsync(),
    Cron.Daily(9)); // 每天早上 9 點執行

// 定期任務：Email 摘要
RecurringJob.AddOrUpdate<IEmailDigestService>(
    "email-digest",
    x => x.SendDailyDigestAsync(),
    Cron.Daily(9));
```

#### 3.8.8 資料庫設計

**Notifications (通知表)**
- Id (PK)
- UserId (FK)
- Type (Enum)
- Title
- Message
- Data (JSONB)
- IsRead
- ReadAt
- CreatedAt

**NotificationPreferences (通知偏好表)**
- Id (PK)
- UserId (FK)
- Preferences (JSONB)
- UpdatedAt

**EmailLogs (郵件記錄表)**
- Id (PK)
- RecipientEmail
- Subject
- TemplateName
- Status (Pending/Sent/Failed/Bounced)
- SentAt
- ErrorMessage
- RetryCount

#### 3.8.9 Webhook 整合

支援在特定事件發生時，向外部系統發送 HTTP 回調通知，實現與第三方系統的即時整合。

**支援的事件類型**

| 事件 | 說明 | Payload 包含 |
|------|------|-------------|
| `form.published` | 表單發布 | formId, title, publishedAt |
| `form.closed` | 表單關閉 | formId, reason |
| `submission.created` | 新提交 | submissionId, formId, data |
| `submission.updated` | 提交更新 | submissionId, changes |
| `submission.reviewed` | 提交審核 | submissionId, status, reviewer |
| `quota.reached` | 名額已滿 | formId, count |
| `deadline.approaching` | 即將截止 | formId, deadline, remainingDays |

**Webhook 設定**
```json
{
  "webhooks": [
    {
      "id": "webhook_001",
      "name": "提交通知到 Slack",
      "url": "https://hooks.slack.com/services/xxx",
      "events": ["submission.created"],
      "method": "POST",
      "headers": {
        "Content-Type": "application/json"
      },
      "secret": "whsec_xxxxx",
      "enabled": true,
      "retryPolicy": {
        "maxRetries": 3,
        "retryInterval": [60, 300, 900]
      }
    }
  ]
}
```

**Webhook Payload 結構**
```json
{
  "id": "evt_abc123",
  "type": "submission.created",
  "timestamp": "2026-01-22T10:30:00Z",
  "data": {
    "formId": "form_001",
    "formTitle": "員工滿意度調查",
    "submissionId": "sub_xyz789",
    "submittedAt": "2026-01-22T10:30:00Z",
    "submittedBy": {
      "id": "user_123",
      "name": "王小明"
    },
    "data": {
      "department": "IT",
      "rating": 4
    }
  }
}
```

**安全性機制**

| 機制 | 說明 |
|------|------|
| HMAC 簽名 | 使用 Secret 對 Payload 簽名，放在 `X-Forma-Signature` Header |
| 時間戳驗證 | `X-Forma-Timestamp` 防止重放攻擊 |
| IP 白名單 | 可限制只接受特定來源 IP |
| TLS 驗證 | 強制 HTTPS |

**簽名驗證範例**
```javascript
const crypto = require('crypto');

function verifySignature(payload, signature, secret) {
  const expectedSignature = crypto
    .createHmac('sha256', secret)
    .update(payload)
    .digest('hex');
  return crypto.timingSafeEqual(
    Buffer.from(signature),
    Buffer.from(`sha256=${expectedSignature}`)
  );
}
```

**重試機制**
- 非 2xx 回應觸發重試
- 預設重試間隔：1 分鐘、5 分鐘、15 分鐘
- 超過重試次數後標記為失敗
- 失敗記錄保留供查詢

**Webhook 管理 API**
```
GET    /api/webhooks                     # 取得 Webhook 列表
POST   /api/webhooks                     # 建立 Webhook
PUT    /api/webhooks/{id}                # 更新 Webhook
DELETE /api/webhooks/{id}                # 刪除 Webhook
POST   /api/webhooks/{id}/test           # 發送測試請求
GET    /api/webhooks/{id}/logs           # 取得發送記錄
POST   /api/webhooks/{id}/retry/{logId}  # 重試失敗的請求
```

**預設整合範本**

| 服務 | 說明 |
|------|------|
| Slack | 傳送訊息到頻道 |
| Microsoft Teams | 傳送卡片訊息 |
| Line Notify | Line 通知 |
| Discord | Discord Webhook |
| 自訂 HTTP | 任意 REST API |

**Webhook 資料表**

**Webhooks (Webhook 設定表)**
- Id (PK)
- FormId (FK, nullable) - 表單級或全域
- ProjectId (FK, nullable)
- Name
- Url
- Events (JSONB)
- Headers (JSONB)
- SecretHash
- Enabled
- CreatedBy
- CreatedAt

**WebhookLogs (Webhook 記錄表)**
- Id (PK)
- WebhookId (FK)
- EventType
- Payload (JSONB)
- ResponseStatus
- ResponseBody
- SentAt
- Duration (ms)
- RetryCount
- ErrorMessage

### 3.9 填寫行為分析

追蹤使用者填寫表單的行為數據，協助表單設計者優化表單體驗、提高完成率。

#### 3.9.1 追蹤指標

**表單層級指標**

| 指標 | 說明 | 計算方式 |
|------|------|----------|
| 瀏覽數 (Views) | 表單被開啟次數 | 頁面載入計數 |
| 開始填寫數 (Starts) | 開始填寫的次數 | 首次輸入計數 |
| 完成數 (Completions) | 成功提交次數 | 提交計數 |
| 完成率 (Completion Rate) | 完成/開始比率 | Completions / Starts |
| 放棄率 (Abandonment Rate) | 未完成比率 | 1 - Completion Rate |
| 平均填寫時間 | 從開始到提交的時間 | Avg(完成時間 - 開始時間) |

**欄位層級指標**

| 指標 | 說明 |
|------|------|
| 欄位互動數 | 該欄位被點擊/聚焦的次數 |
| 欄位修改數 | 該欄位內容被修改的次數 |
| 欄位停留時間 | 在該欄位花費的時間 |
| 欄位放棄點 | 在該欄位放棄的比率 |
| 驗證錯誤數 | 該欄位觸發驗證錯誤的次數 |
| 回填次數 | 回頭修改該欄位的次數 |

#### 3.9.2 追蹤事件

**事件類型定義**
```typescript
type AnalyticsEvent =
  | { type: 'form_view'; formId: string; timestamp: Date }
  | { type: 'form_start'; formId: string; timestamp: Date }
  | { type: 'field_focus'; fieldId: string; timestamp: Date }
  | { type: 'field_blur'; fieldId: string; value?: any; timestamp: Date }
  | { type: 'field_change'; fieldId: string; timestamp: Date }
  | { type: 'validation_error'; fieldId: string; rule: string; timestamp: Date }
  | { type: 'page_change'; fromPage: number; toPage: number; timestamp: Date }
  | { type: 'form_submit'; success: boolean; timestamp: Date }
  | { type: 'form_abandon'; lastFieldId?: string; timestamp: Date };
```

**事件收集流程**
```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 使用者操作   │────►│ 事件緩衝區  │────►│ 批次發送    │────►│ 分析服務    │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
                          │                    │
                     10 秒或 20 筆         POST /api/analytics/events
                     任一條件觸發
```

#### 3.9.3 分析儀表板

**概覽面板**
```
┌─────────────────────────────────────────────────────────────────┐
│  表單分析 - 員工滿意度調查                      📅 最近 30 天  ▼  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │   1,234  │  │    856   │  │    698   │  │   81.5%  │       │
│  │  瀏覽數  │  │ 開始填寫 │  │  完成數  │  │  完成率  │       │
│  │  +12%    │  │  +8%     │  │  +15%    │  │  +5%     │       │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘       │
│                                                                 │
│  平均填寫時間: 4 分 32 秒                                        │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  📈 填寫趨勢                                                    │
│  [折線圖：每日瀏覽/開始/完成數]                                   │
├─────────────────────────────────────────────────────────────────┤
│  🔥 欄位熱力圖                                                  │
│  [顯示各欄位停留時間/放棄率]                                      │
└─────────────────────────────────────────────────────────────────┘
```

**漏斗分析**
```
表單填寫漏斗

瀏覽表單       ████████████████████████████████████  1,234 (100%)
                              │
                              ▼ 69.4%
開始填寫       █████████████████████████             856 (69.4%)
                              │
                              ▼ 91.2%
完成第一頁     ███████████████████████               780 (63.2%)
                              │
                              ▼ 95.1%
完成第二頁     ██████████████████████                742 (60.1%)
                              │
                              ▼ 94.1%
提交表單       █████████████████████                 698 (56.6%)

💡 建議：第一步的流失率較高 (30.6%)，考慮簡化首頁欄位
```

**欄位問題診斷**

| 欄位 | 停留時間 | 修改次數 | 錯誤率 | 放棄率 | 診斷 |
|------|----------|----------|--------|--------|------|
| email | 8.2s | 1.8 | 12% | 2% | ⚠️ 錯誤率偏高 |
| phone | 15.3s | 2.4 | 25% | 8% | 🔴 需要優化 |
| address | 22.1s | 1.2 | 3% | 1% | ✅ 正常 |
| department | 3.1s | 1.0 | 0% | 0% | ✅ 正常 |

#### 3.9.4 隱私保護

**資料匿名化**
- 不記錄實際填寫內容，僅記錄行為
- 使用 Session ID 而非 User ID（可選）
- 定期清除原始事件資料（保留聚合結果）

**使用者同意**
```json
{
  "analyticsConsent": {
    "required": false,
    "showBanner": true,
    "bannerText": "我們收集匿名使用數據以改善表單體驗",
    "allowOptOut": true
  }
}
```

**資料保留政策**
| 資料類型 | 保留期間 |
|----------|----------|
| 原始事件 | 90 天 |
| 每日聚合 | 2 年 |
| 每月聚合 | 永久 |

#### 3.9.5 技術實作

**前端 SDK**
```typescript
// 初始化
const analytics = new FormAnalytics({
  formId: 'form_001',
  sessionId: generateSessionId(),
  endpoint: '/api/analytics/events',
  batchSize: 20,
  flushInterval: 10000  // 10 秒
});

// 自動追蹤
analytics.trackFormView();
analytics.attachFieldTracking(formElement);

// 手動追蹤
analytics.track('custom_event', { action: 'click_help' });
```

**後端儲存**

**FormAnalyticsEvents (事件表 - 時序資料)**
- Id (PK)
- FormId (FK)
- SessionId
- EventType
- FieldId (nullable)
- EventData (JSONB)
- Timestamp
- UserAgent
- DeviceType

**FormAnalyticsSummary (聚合表)**
- Id (PK)
- FormId (FK)
- Date
- Views
- Starts
- Completions
- AvgDuration
- FieldStats (JSONB)

**分析 API**
```
GET  /api/forms/{id}/analytics/overview    # 概覽數據
GET  /api/forms/{id}/analytics/funnel      # 漏斗分析
GET  /api/forms/{id}/analytics/fields      # 欄位分析
GET  /api/forms/{id}/analytics/trends      # 趨勢數據
POST /api/analytics/events                  # 批次上傳事件
```

---

## 4. API 設計

### 4.1 RESTful API 端點

#### 認證 & 授權
```
POST   /api/auth/register      # 註冊
POST   /api/auth/login         # 登入
POST   /api/auth/refresh       # 刷新 Token
POST   /api/auth/logout        # 登出
GET    /api/auth/profile       # 取得個人資料
PUT    /api/auth/profile       # 更新個人資料
```

#### 組織管理
```
GET    /api/organizations           # 取得組織列表
GET    /api/organizations/{id}      # 取得組織詳情
POST   /api/organizations           # 建立組織（系統管理員）
PUT    /api/organizations/{id}      # 更新組織
DELETE /api/organizations/{id}      # 刪除組織
```

#### 計畫管理
```
GET    /api/projects                # 取得計畫列表（當前使用者有權限的）
GET    /api/projects/managed        # 取得我管理的計畫（Owner + Manager）
GET    /api/projects/participated   # 取得我參與的計畫（所有角色）
GET    /api/projects/{id}           # 取得計畫詳情
POST   /api/projects                # 建立計畫
PUT    /api/projects/{id}           # 更新計畫
DELETE /api/projects/{id}           # 刪除計畫（僅 Owner）
POST   /api/projects/{id}/archive   # 封存計畫
GET    /api/organizations/{orgId}/projects  # 取得組織下的所有計畫
```

#### 計畫成員管理
```
GET    /api/projects/{id}/members         # 取得成員列表
POST   /api/projects/{id}/members         # 新增成員
PUT    /api/projects/{id}/members/{uid}   # 更新成員角色
DELETE /api/projects/{id}/members/{uid}   # 移除成員
GET    /api/projects/{id}/members/available  # 取得可新增的使用者列表
```

#### 表單管理
```
GET    /api/projects/{projectId}/forms      # 取得計畫下的表單列表
GET    /api/forms/{id}                      # 取得表單詳情
POST   /api/projects/{projectId}/forms      # 在計畫下建立表單
PUT    /api/forms/{id}                      # 更新表單
DELETE /api/forms/{id}                      # 刪除表單
POST   /api/forms/{id}/publish              # 發布表單
POST   /api/forms/{id}/unpublish            # 下架表單
POST   /api/forms/{id}/clone                # 複製表單
GET    /api/forms/{id}/versions             # 取得表單版本歷史
```

#### 表單提交
```
POST   /api/submissions        # 提交表單
GET    /api/submissions/{id}   # 取得提交詳情
GET    /api/forms/{id}/submissions  # 取得表單的所有提交
PUT    /api/submissions/{id}   # 更新提交（依權限）
DELETE /api/submissions/{id}   # 刪除提交
```

#### 範本管理
```
GET    /api/templates          # 取得範本列表
GET    /api/templates/{id}     # 取得範本詳情
POST   /api/templates          # 建立範本
PUT    /api/templates/{id}     # 更新範本
DELETE /api/templates/{id}     # 刪除範本
```

#### 權限管理
```
GET    /api/permissions/form/{id}     # 取得表單權限
POST   /api/permissions                # 授予權限
DELETE /api/permissions/{id}           # 移除權限
```

#### 報告與匯出
```
GET    /api/reports/{formId}           # 取得報告
POST   /api/exports                    # 建立匯出任務
GET    /api/exports/{id}/download      # 下載匯出檔案
```

#### 儀表板與跨計畫查詢
```
GET    /api/dashboard/summary          # 取得個人儀表板摘要
GET    /api/dashboard/pending-tasks    # 取得待辦事項（跨計畫）
GET    /api/dashboard/recent-activities # 取得最近活動
GET    /api/dashboard/statistics       # 取得個人統計資料
GET    /api/dashboard/projects/stats   # 取得所有參與計畫的統計
GET    /api/submissions/pending-review # 取得所有待審核提交（跨計畫）
```

#### 通知管理
```
GET    /api/notifications              # 取得通知列表
GET    /api/notifications/unread-count # 取得未讀數量
PUT    /api/notifications/{id}/read    # 標記為已讀
PUT    /api/notifications/read-all     # 全部標記已讀
DELETE /api/notifications/{id}         # 刪除通知
GET    /api/notifications/preferences  # 取得通知偏好設定
PUT    /api/notifications/preferences  # 更新通知偏好設定
POST   /api/notifications/test-email   # 發送測試郵件（管理員）
```

### 4.2 回應格式
```json
{
  "success": true,
  "data": {},
  "message": "操作成功",
  "timestamp": "2026-01-22T12:00:00Z"
}
```

### 4.3 錯誤處理
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "驗證失敗",
    "details": []
  },
  "timestamp": "2026-01-22T12:00:00Z"
}
```

---

## 5. 安全性設計

### 5.1 認證機制
- JWT Token (Access + Refresh)
- Token 過期處理
- 安全的密碼雜湊 (bcrypt/Argon2)

### 5.2 授權機制
- Role-based Access Control (RBAC)
- Resource-based Authorization
- 細粒度權限控制

### 5.3 資料安全
- HTTPS 加密傳輸
- 敏感資料加密儲存
- SQL Injection 防護 (使用 ORM)
- XSS 防護
- CSRF Token

### 5.4 其他安全措施
- API Rate Limiting
- 請求大小限制
- 檔案類型驗證
- 審計日誌記錄
- 定期安全更新

---

## 6. 效能優化

### 6.1 前端優化
- 程式碼分割 (Code Splitting)
- 懶加載 (Lazy Loading)
- 虛擬滾動處理大型列表
- 圖片優化與 CDN
- Service Worker 快取

### 6.2 後端優化
- Redis 快取熱門資料
- 資料庫索引優化
- 查詢結果快取
- 分頁查詢
- 非同步處理耗時任務

### 6.3 資料庫優化
- 適當的索引設計
- JSONB 欄位索引
- 連線池管理
- 讀寫分離（未來擴展）

---

## 7. 部署架構

### 7.1 開發環境
```
- Frontend: npm run dev (localhost:3000)
- Backend: dotnet run (localhost:5000)
- Database: PostgreSQL (localhost:5432)
- Redis: localhost:6379
```

### 7.2 生產環境
```
┌──────────────┐
│   Nginx      │  # 反向代理 + 靜態檔案
└──────┬───────┘
       │
   ┌───┴────┐
   │        │
┌──▼──┐  ┌──▼──┐
│ API │  │ API │  # .NET Core (多實例)
└──┬──┘  └──┬──┘
   │        │
   └───┬────┘
       │
   ┌───▼────────┐
   │ PostgreSQL │
   └────────────┘
```

### 7.3 Docker 部署
- 前端 Docker Image
- 後端 Docker Image
- Docker Compose 本地開發
- Kubernetes 生產環境（可選）

---

## 8. 測試策略

### 8.1 前端測試
- 單元測試: Jest + React Testing Library
- 元件測試: Storybook
- E2E 測試: Playwright / Cypress

### 8.2 後端測試
- 單元測試: xUnit
- 整合測試: WebApplicationFactory
- API 測試: Postman / RestSharp

### 8.3 測試覆蓋率
- 目標: 80% 以上

---

## 9. 開發流程

### 9.1 Git 工作流程
- main: 生產環境
- develop: 開發環境
- feature/*: 功能開發
- bugfix/*: 錯誤修復
- release/*: 版本發布

### 9.2 CI/CD
- GitHub Actions / Azure DevOps
- 自動化測試
- 自動化部署
- 程式碼品質檢查

---

## 10. 未來擴展

### 10.1 第一階段（完成核心功能）
- 基本表單建立與提交
- 使用者認證與授權
- 資料管理與匯出

### 10.2 第二階段（增強功能）
- 進階報告生成
- 表單範本市集
- 工作流程整合
- 電子郵件通知

### 10.3 第三階段（企業級功能）
- 多租戶架構
- 進階分析儀表板
- API 整合能力
- 移動應用程式
- 第三方服務整合（Zapier, Webhook）

---

## 11. 開發時程估算

| 階段 | 功能 | 預估時間 |
|------|------|----------|
| 基礎設施 | 專案架構、資料庫、認證 | 2 週 |
| 表單建立器 | 拖拉介面、元件庫 | 3-4 週 |
| 表單填寫 | 渲染引擎、提交邏輯 | 2 週 |
| 資料管理 | 列表、搜尋、篩選 | 2 週 |
| 權限系統 | RBAC 實作 | 1 週 |
| 匯出功能 | Excel, PDF 生成 | 1 週 |
| 報告系統 | 圖表、統計 | 2-3 週 |
| 範本系統 | 範本管理 | 1 週 |
| 測試與優化 | 測試、效能調校 | 2 週 |

**總計**: 約 16-19 週（4-5 個月）

---

## 12. 技術風險與應對

### 12.1 潛在風險
- 複雜表單的效能問題
- JSONB 查詢效能
- 大量並發提交
- 檔案上傳與儲存

### 12.2 應對策略
- 分頁載入與虛擬滾動
- 適當的資料庫索引
- 快取策略
- CDN 與物件儲存服務

---

## 附錄

### A. 相關文件
- API 文件: Swagger UI
- 資料庫 Schema: dbdiagram.io
- UI/UX 設計稿: Figma

### B. 參考資源
- React 官方文件
- .NET Core 官方文件
- PostgreSQL 官方文件
- Material-UI / Ant Design 文件

### C. 聯絡資訊
- 專案負責人: [待填寫]
- 技術負責人: [待填寫]

### D. 表單 Schema 規範

本附錄定義動態表單的完整 JSON Schema 規範，支援多種表單元件類型、靈活的驗證規則、條件邏輯、計算欄位、重複區段及動態選項載入。設計參考 SurveyJS 等成熟表單庫的元件類型。

#### D.1 表單整體結構

```json
{
  "version": "1.0",
  "id": "uuid",
  "metadata": {
    "title": "表單標題",
    "description": "表單說明",
    "language": "zh-TW",
    "submitButtonText": "提交",
    "successMessage": "感謝您的提交！"
  },
  "settings": {
    "allowDraft": true,
    "allowMultipleSubmissions": false,
    "requireAuthentication": true,
    "showProgressBar": true,
    "enableAutoSave": true,
    "autoSaveInterval": 30
  },
  "pages": [
    {
      "id": "page_1",
      "title": "第一頁",
      "description": "頁面說明",
      "fields": []
    }
  ],
  "theme": {
    "primaryColor": "#1976d2",
    "fontFamily": "Noto Sans TC"
  }
}
```

#### D.2 元件類型列舉

**文字輸入類**
| 類型 | 說明 | 用途 |
|------|------|------|
| `text` | 單行文字 | 姓名、標題等短文字 |
| `textarea` | 多行文字 | 意見、描述等長文字 |
| `multipletext` | 多重文字輸入 | 多個短文字欄位組合（如地址分段） |
| `email` | 電子郵件 | Email 欄位（含格式驗證） |
| `phone` | 電話號碼 | 聯絡電話（含格式遮罩） |
| `url` | 網址 | URL 輸入 |
| `password` | 密碼 | 密碼輸入（遮罩顯示） |

**數值輸入類**
| 類型 | 說明 | 用途 |
|------|------|------|
| `number` | 數字輸入 | 年齡、數量等數值 |
| `slider` | 滑桿 | 數值範圍選擇 |
| `rating` | 評分 | 星級/數字評分 |

**日期時間類**
| 類型 | 說明 | 用途 |
|------|------|------|
| `date` | 日期 | 日期選擇器 |
| `time` | 時間 | 時間選擇器 |
| `datetime` | 日期時間 | 完整日期時間戳 |

**選擇類**
| 類型 | 說明 | 用途 |
|------|------|------|
| `select` | 下拉選單 | 單選下拉列表 |
| `multiselect` | 多選下拉 | 多選標籤式下拉 (TagBox) |
| `radio` | 單選按鈕 | 可見選項單選 |
| `checkbox` | 核取方塊 | 多選勾選 |
| `boolean` | 是/否開關 | 二元選擇（切換開關） |
| `imagepicker` | 圖片選擇 | 從圖片選項中選擇 |
| `ranking` | 排序題 | 拖拉排列項目順序 |

**矩陣類**
| 類型 | 說明 | 用途 |
|------|------|------|
| `matrix` | 單選矩陣 | 表格式單選題（每行單選） |
| `matrixdropdown` | 下拉矩陣 | 表格式多欄位選擇 |
| `matrixdynamic` | 動態矩陣 | 可新增/刪除列的矩陣表格 |

**檔案與媒體類**
| 類型 | 說明 | 用途 |
|------|------|------|
| `file` | 檔案上傳 | 附件上傳 |
| `image` | 圖片上傳 | 圖片專用上傳 |
| `signature` | 簽名 | 電子簽名板 |

**版面配置類**
| 類型 | 說明 | 用途 |
|------|------|------|
| `panel` | 面板/區段 | 欄位群組容器 |
| `section` | 區段標題 | 分組標題（純顯示） |
| `html` | HTML 內容 | 自訂 HTML 顯示 |

**特殊類**
| 類型 | 說明 | 用途 |
|------|------|------|
| `hidden` | 隱藏欄位 | 預填/傳遞資料 |
| `expression` | 計算欄位 | 自動計算數值（唯讀） |
| `paneldynamic` | 動態面板 | 可重複新增的欄位群組 |

#### D.3 元件通用屬性結構

```json
{
  "id": "field_uuid",
  "type": "text",
  "name": "fieldName",
  "label": "欄位標籤",
  "description": "欄位說明文字（可選）",
  "placeholder": "提示文字",
  "defaultValue": null,
  "required": false,
  "disabled": false,
  "readOnly": false,
  "visible": true,
  "validation": {},
  "conditional": null,
  "properties": {},
  "layout": {
    "width": "full",
    "order": 1
  }
}
```

#### D.4 各元件類型專屬屬性 (properties)

**text / textarea / email / phone / url / password**
```json
{
  "minLength": 0,
  "maxLength": 500,
  "pattern": null,
  "rows": 4,
  "inputMask": null
}
```

**multipletext**
```json
{
  "items": [
    { "name": "street", "label": "街道", "placeholder": "請輸入街道" },
    { "name": "city", "label": "城市", "placeholder": "請輸入城市" }
  ],
  "colCount": 2
}
```

**number / slider**
```json
{
  "min": null,
  "max": null,
  "step": 1,
  "precision": 0,
  "unit": "",
  "showButtons": true
}
```

**select / multiselect / radio / checkbox**
```json
{
  "options": [
    { "value": "opt1", "label": "選項一", "disabled": false },
    { "value": "opt2", "label": "選項二", "disabled": false }
  ],
  "allowOther": false,
  "otherLabel": "其他",
  "noneOption": false,
  "noneLabel": "以上皆非",
  "selectAllOption": false,
  "selectAllLabel": "全選",
  "minSelect": null,
  "maxSelect": null,
  "colCount": 1,
  "optionsSource": null
}
```

**boolean**
```json
{
  "labelTrue": "是",
  "labelFalse": "否",
  "displayStyle": "switch"
}
```

**imagepicker**
```json
{
  "choices": [
    { "value": "opt1", "imageUrl": "/images/opt1.png", "label": "選項一" },
    { "value": "opt2", "imageUrl": "/images/opt2.png", "label": "選項二" }
  ],
  "multiSelect": false,
  "showLabel": true,
  "imageWidth": 150,
  "imageHeight": 150
}
```

**ranking**
```json
{
  "choices": [
    { "value": "item1", "label": "項目一" },
    { "value": "item2", "label": "項目二" }
  ],
  "maxSelectedChoices": null,
  "selectToRankEnabled": false
}
```

**date / time / datetime**
```json
{
  "minDate": null,
  "maxDate": null,
  "format": "YYYY-MM-DD",
  "disabledDates": [],
  "disabledDaysOfWeek": []
}
```

**file / image**
```json
{
  "accept": [".pdf", ".docx", ".jpg", ".png"],
  "maxSize": 10485760,
  "maxFiles": 5,
  "multiple": true,
  "allowCamera": false
}
```

**rating**
```json
{
  "maxRating": 5,
  "icon": "star",
  "allowHalf": false,
  "labels": ["非常不滿意", "不滿意", "普通", "滿意", "非常滿意"],
  "displayMode": "buttons"
}
```

**matrix**
```json
{
  "rows": [
    { "id": "row1", "label": "問題一" },
    { "id": "row2", "label": "問題二" }
  ],
  "columns": [
    { "id": "col1", "label": "非常同意", "value": 5 },
    { "id": "col2", "label": "同意", "value": 4 }
  ],
  "alternateRows": true,
  "showHeader": true
}
```

**matrixdropdown**
```json
{
  "rows": [
    { "id": "row1", "label": "產品 A" },
    { "id": "row2", "label": "產品 B" }
  ],
  "columns": [
    { "name": "quality", "label": "品質", "cellType": "rating" },
    { "name": "price", "label": "價格", "cellType": "dropdown", "options": [...] }
  ]
}
```

**matrixdynamic**
```json
{
  "columns": [
    { "name": "item", "label": "項目", "cellType": "text" },
    { "name": "quantity", "label": "數量", "cellType": "number" }
  ],
  "minRowCount": 1,
  "maxRowCount": 10,
  "addRowText": "新增一列",
  "removeRowText": "刪除"
}
```

**signature**
```json
{
  "width": 400,
  "height": 200,
  "penColor": "#000000",
  "backgroundColor": "#ffffff"
}
```

**expression（計算欄位）**
```json
{
  "formula": "fields.quantity * fields.unitPrice",
  "precision": 2,
  "unit": "元",
  "displayFormat": "currency"
}
```

**panel**
```json
{
  "title": "群組標題",
  "description": "群組說明",
  "collapsible": false,
  "collapsed": false,
  "fields": []
}
```

**paneldynamic（重複區段）**
```json
{
  "minItems": 1,
  "maxItems": 10,
  "addButtonText": "新增一筆",
  "removeButtonText": "刪除",
  "itemLabel": "項目 {index}",
  "fields": [
    {
      "id": "contact_name",
      "type": "text",
      "name": "name",
      "label": "姓名",
      "required": true
    },
    {
      "id": "contact_phone",
      "type": "phone",
      "name": "phone",
      "label": "電話"
    }
  ]
}
```

**html**
```json
{
  "content": "<p>這是一段<strong>說明文字</strong></p>"
}
```

#### D.5 動態選項來源 (optionsSource)

當選項需要從 API 動態載入時，使用 `optionsSource` 取代靜態 `options`：

```json
{
  "optionsSource": {
    "type": "api",
    "url": "/api/lookup/cities",
    "method": "GET",
    "params": {
      "country": "{fields.country}"
    },
    "headers": {},
    "valuePath": "data[].code",
    "labelPath": "data[].name",
    "cache": true,
    "cacheDuration": 300,
    "dependsOn": ["country"],
    "placeholder": "請先選擇國家"
  }
}
```

| 參數 | 說明 |
|------|------|
| `type` | 來源類型：`api`、`lookup`（系統內建查詢表）|
| `url` | API 端點 |
| `method` | HTTP 方法 |
| `params` | 查詢參數，可引用其他欄位值 `{fields.xxx}` |
| `valuePath` | JSON 回應中取值的路徑 |
| `labelPath` | JSON 回應中取標籤的路徑 |
| `cache` | 是否快取結果 |
| `cacheDuration` | 快取時間（秒）|
| `dependsOn` | 依賴欄位，當依賴欄位變更時重新載入 |
| `placeholder` | 依賴欄位未填時的提示文字 |

#### D.6 計算欄位公式語法

**支援運算符**
| 運算符 | 說明 | 範例 |
|--------|------|------|
| `+` | 加法 | `fields.a + fields.b` |
| `-` | 減法 | `fields.total - fields.discount` |
| `*` | 乘法 | `fields.qty * fields.price` |
| `/` | 除法 | `fields.total / fields.count` |
| `%` | 取餘 | `fields.value % 10` |
| `()` | 括號 | `(fields.a + fields.b) * fields.c` |

**內建函數**
| 函數 | 說明 | 範例 |
|------|------|------|
| `SUM(...)` | 加總 | `SUM(fields.item1, fields.item2)` |
| `AVG(...)` | 平均 | `AVG(fields.score1, fields.score2)` |
| `MIN(...)` | 最小值 | `MIN(fields.price1, fields.price2)` |
| `MAX(...)` | 最大值 | `MAX(fields.bid1, fields.bid2)` |
| `ROUND(value, decimals)` | 四捨五入 | `ROUND(fields.avg, 2)` |
| `FLOOR(value)` | 無條件捨去 | `FLOOR(fields.value)` |
| `CEIL(value)` | 無條件進位 | `CEIL(fields.value)` |
| `ABS(value)` | 絕對值 | `ABS(fields.diff)` |
| `IF(cond, true, false)` | 條件判斷 | `IF(fields.age >= 18, "成人", "未成年")` |
| `CONCAT(...)` | 字串連接 | `CONCAT(fields.lastName, fields.firstName)` |
| `COUNT(panel)` | 動態面板筆數 | `COUNT(fields.items)` |
| `SUM_FIELD(panel, field)` | 動態面板欄位加總 | `SUM_FIELD(fields.items, "amount")` |

**動態面板內計算**：使用 `fields.$current` 表示當前項目的欄位，例如：
```
fields.$current.quantity * fields.$current.unitPrice
```

#### D.7 驗證規則結構 (validation)

```json
{
  "validation": {
    "rules": [
      {
        "type": "required",
        "message": "此欄位為必填"
      },
      {
        "type": "minLength",
        "value": 10,
        "message": "至少需要輸入 10 個字元"
      },
      {
        "type": "pattern",
        "value": "^[A-Z][0-9]{9}$",
        "message": "請輸入正確的身分證字號格式"
      },
      {
        "type": "custom",
        "expression": "value > fields.startDate",
        "message": "結束日期必須大於開始日期"
      }
    ]
  }
}
```

**內建驗證類型**
| 類型 | 適用元件 | value 參數 |
|------|----------|-----------|
| `required` | 所有 | - |
| `minLength` | text, textarea | 數字 |
| `maxLength` | text, textarea | 數字 |
| `min` | number, slider, date | 數字/日期 |
| `max` | number, slider, date | 數字/日期 |
| `pattern` | text, email, phone | 正則表達式 |
| `email` | email | - |
| `url` | text | - |
| `minSelect` | multiselect, checkbox | 數字 |
| `maxSelect` | multiselect, checkbox | 數字 |
| `fileSize` | file, image | bytes |
| `fileType` | file, image | 副檔名陣列 |
| `custom` | 所有 | 表達式 |

#### D.8 條件邏輯結構 (conditional)

**單一條件**
```json
{
  "conditional": {
    "action": "show",
    "when": {
      "field": "question_1",
      "operator": "equals",
      "value": "yes"
    }
  }
}
```

**多條件組合**
```json
{
  "conditional": {
    "action": "show",
    "logicType": "and",
    "conditions": [
      {
        "field": "age",
        "operator": "gte",
        "value": 18
      },
      {
        "field": "country",
        "operator": "in",
        "value": ["TW", "JP", "KR"]
      }
    ]
  }
}
```

**條件運算符**
| 運算符 | 說明 |
|--------|------|
| `equals` | 等於 |
| `notEquals` | 不等於 |
| `contains` | 包含 |
| `notContains` | 不包含 |
| `gt` | 大於 |
| `gte` | 大於等於 |
| `lt` | 小於 |
| `lte` | 小於等於 |
| `in` | 在列表中 |
| `notIn` | 不在列表中 |
| `isEmpty` | 為空 |
| `isNotEmpty` | 不為空 |
| `startsWith` | 開頭為 |
| `endsWith` | 結尾為 |

**條件動作**
| 動作 | 說明 |
|------|------|
| `show` | 顯示欄位（預設隱藏）|
| `hide` | 隱藏欄位（預設顯示）|
| `enable` | 啟用欄位 |
| `disable` | 停用欄位 |
| `require` | 設為必填 |
| `unrequire` | 設為非必填 |

#### D.9 提交資料結構 (SubmissionData)

```json
{
  "formId": "survey_001",
  "formVersion": "1.0",
  "submittedAt": "2026-01-22T10:30:00Z",
  "data": {
    "department": "it",
    "yearsOfService": 5,
    "overallSatisfaction": 4,
    "environmentMatrix": {
      "office": 4,
      "equipment": 3,
      "welfare": 4
    },
    "items": [
      {
        "_index": 0,
        "name": "商品A",
        "quantity": 2,
        "unitPrice": 100,
        "subtotal": 200
      }
    ],
    "total": 200
  },
  "metadata": {
    "duration": 325,
    "device": "desktop",
    "browser": "Chrome 120"
  }
}
```

#### D.10 TypeScript 型別定義

前端 TypeScript 型別定義位於 `frontend/src/types/form.ts`，包含 `FormSchema`, `Field`, `ValidationRule`, `Conditional` 等完整型別定義。
